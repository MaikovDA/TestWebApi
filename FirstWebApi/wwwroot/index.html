<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width"/>
	<title>User list</title>
	<link rel="icon" href="data:;base64,=">
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
<h4>Exercise 2</h4>
<article>
	Create DB.
	Add table User (Id uniqueidentifier, FirstName nvarchar (100) not null, LastName nvarchar (100) not null, MiddleName nvarchar (100) null)
	Implement an ASP.NET application to manipulate Users from this table. CRUD operation must be supported by UI. Use frameworks convenient to you. User.Id must be generated by your application.
</article>
<hr>
<section style="margin-left: 30px;">
	<h4>User Form</h4>
	<form name="userForm">
		<input type="hidden" name="id"/>
		<div class="form-group col-md-5">
			<label for="firstName">FirstName:</label>
			<input class="form-control" required placeholder="Enter first name" name="firstName"/>
		</div>
		<div class="form-group col-md-5">
			<label for="lastName">LastName:</label>
			<input class="form-control" required placeholder="Enter last name" name="lastName"/>
		</div>
		<div class="form-group col-md-5">
			<label for="middleName">MiddleName:</label>
			<input class="form-control" placeholder="Enter middle name" name="middleName"/>
		</div>
		<div class="panel-body">
			<button type="submit" id="submit" class="btn btn-primary">Сохранить</button>
			<a id="reset" class="btn btn-primary">Сбросить</a>
		</div>
	</form>
	<br/>
</section>
<hr>
<div style="margin-left: 30px;">
<h4>User list</h4>
<table class="table table-condensed table-striped  col-md-6">
	<thead>
	<tr>
		<th>Id</th><th>FirstName</th><th>LastName</th><th>MiddleName</th><th></th>
	</tr>
	</thead>
	<tbody>
	</tbody>
</table>
</divstyle="margin-left:>
<script>
	// Получение всех пользователей
	async function GetUsers() {
		// отправляет запрос и получаем ответ
		const response = await fetch("/api/users",
			{
				method: "GET",
				headers: { "Accept": "application/json" }
			});
		// если запрос прошел нормально
		if (response.ok === true) {
			// получаем данные
			const users = await response.json();
			let rows = document.querySelector("tbody");
			users.forEach(user => {
				// добавляем полученные элементы в таблицу
				rows.append(row(user));
			});
		}
	}

	// Получение одного пользователя
	async function GetUser(id) {
		const response = await fetch("/api/users/" + id,
			{
				method: "GET",
				headers: { "Accept": "application/json" }
			});
		if (response.ok === true) {
			const user = await response.json();
			const form = document.forms["userForm"];
			form.elements["id"].value = user.id;
			form.elements["firstName"].value = user.firstName;
			form.elements["lastName"].value = user.lastName;
			form.elements["middleName"].value = user.middleName;
		}
	}

	// Добавление пользователя
	async function CreateUser(firstName, lastName, middleName) {

		const response = await fetch("api/users",
			{
				method: "POST",
				headers: { "Accept": "application/json", "Content-Type": "application/json" },
				body: JSON.stringify({
					firstName: firstName,
					lastName: lastName,
					middleName: middleName
				})
			});
		if (response.ok === true) {
			const user = await response.json();
			reset();
			document.querySelector("tbody").append(row(user));
		}
	}

	// Изменение пользователя
	async function EditUser(userId, firstName, lastName, middleName) {
		const response = await fetch("api/users",
			{
				method: "PUT",
				headers: { "Accept": "application/json", "Content-Type": "application/json" },
				body: JSON.stringify({
					id: userId,
					firstName: firstName,
					lastName: lastName,
					middleName: middleName
				})
			});
		if (response.ok === true) {
			const user = await response.json();
			reset();
			document.querySelector("tr[data-rowid='" + user.id + "']").replaceWith(row(user));
		}
	}

	// Удаление пользователя
	async function DeleteUser(id) {
		const response = await fetch("/api/users/" + id,
			{
				method: "DELETE",
				headers: { "Accept": "application/json" }
			});
		if (response.ok === true) {
			const user = await response.json();
			document.querySelector("tr[data-rowid='" + user.id + "']").remove();
		}
	}

	// сброс формы
	function reset() {
		const form = document.forms["userForm"];
		form.reset();
		form.elements["id"].value = null;
		form.elements["firstName"].value = null;
		form.elements["lastName"].value = null;
		form.elements["middleName"].value = null;
	}

	// создание строки для таблицы
	function row(user) {

		const tr = document.createElement("tr");
		tr.setAttribute("data-rowid", user.id);

		const idTd = document.createElement("td");
		idTd.append(user.id);
		tr.append(idTd);

		const firstNameTd = document.createElement("td");
		firstNameTd.append(user.firstName);
		tr.append(firstNameTd);

		const lasttNameTd = document.createElement("td");
		lasttNameTd.append(user.lastName);
		tr.append(lasttNameTd);

		const middleNameTd = document.createElement("td");
		middleNameTd.append(user.middleName);
		tr.append(middleNameTd);

		const linksTd = document.createElement("td");

		const editLink = document.createElement("a");
		editLink.setAttribute("data-id", user.id);
		editLink.setAttribute("style", "cursor:pointer;padding:15px;color:blue;");
		editLink.append("Edit");
		editLink.addEventListener("click",
			e => {

				e.preventDefault();
				GetUser(user.id);
			});
		linksTd.append(editLink);

		const removeLink = document.createElement("a");
		removeLink.setAttribute("data-id", user.id);
		removeLink.setAttribute("style", "cursor:pointer;padding:15px;color:blue;");
		removeLink.append("Delete");
		removeLink.addEventListener("click",
			e => {

				e.preventDefault();
				DeleteUser(user.id);
			});

		linksTd.append(removeLink);
		tr.appendChild(linksTd);

		return tr;
	}

	// сброс значений формы
	document.getElementById("reset").click(function(e) {

		e.preventDefault();
		reset();
	});

	// отправка формы
	document.forms["userForm"].addEventListener("submit",
		e => {
			e.preventDefault();
			const form = document.forms["userForm"];
			const id = form.elements["id"].value;
			const firstName = form.elements["firstName"].value;
			const lastName = form.elements["lastName"].value;
			const middleName = form.elements["middleName"].value;

			if (!id)
				CreateUser(firstName, lastName, middleName);
			else
				EditUser(id, firstName, lastName, middleName);
		});

	// загрузка пользователей
	GetUsers();

</script>
</body>
</html>